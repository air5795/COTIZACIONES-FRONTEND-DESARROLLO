
<div class="container">
    <div style="display: flex; align-items: center; justify-content: space-between;  background-color: #e3e3e3; padding: 5px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="pi pi-money-bill" style="color: #2f7a3f; font-size: 1.5rem;"></i>
          <span style="font-size: 1.25rem; font-weight: bold; color: #5f5f5f;">Pagos</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <button 
          pButton 
          style="border: 1px;" 
          label="Subir Pago" 
          class="p-button-outlined p-button-primary mr-2" 
          icon="pi pi-plus" 
          (click)="openCreatePagoDialog()"
          [disabled]="pagos.length > 0">
      </button>
          <button pButton type="button" class="p-button p-button-sm" style="display: flex; align-items: center; gap: 15px; padding: 7px 10px; font-size: large; background-color: #007d00;">
            <i class="pi pi-wallet"></i> <span> {{totalRecords}}</span>
          </button>
          
        </div>
      </div>
    
  
<div class="container">

  
    <!-- Tabla PrimeNG -->
    <p-table
      [value]="pagos"
      [paginator]="true"
      [rows]="limite"
      [totalRecords]="totalRecords"
      [loading]="loading"
      [rowsPerPageOptions]="[5, 10, 15, 20, -1]"
      [pageLinks]="5"
      [lazy]="true"
      responsiveLayout="scroll"
      styleClass="p-datatable-sm p-datatable-striped"
      [style]="{'font-size': '12px', 'border': '1px solid #dee2e6'}"
      (onLazyLoad)="loadPagos($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando registros del {first} al {last} de un total de {totalRecords} registros"
    >

      <ng-template pTemplate="header">
        <tr style="background-color: #f8f9fa;">
          
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Fecha Pago</th>
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Monto Pagado</th>
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Método Pago</th>
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Comprobante</th>
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Observaciones</th>
          <th style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">Foto Comprobante</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-pago let-i="rowIndex">
        <tr style="background-color: #d5ffe9;">
         
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">{{ pago.fecha_pago | formatFecha }}</td>
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">{{ pago.monto_pagado }}</td>
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">{{ pago.metodo_pago }}</td>
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">{{ pago.comprobante_pago }}</td>
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">{{ pago.observaciones }}</td>
          <td style="text-align: center; padding: 5px; border: 1px solid #dee2e6;">
            <button 
              pButton 
              label="Ver comprobante"
              icon="pi pi-eye" 
              class="p-button p-button-primary" 
              [disabled]="!pago.foto_comprobante" 
              style="width: 100%;"
              (click)="openImageDialog(pago)"
            ></button>
          </td>
        </tr>
      </ng-template>
      <!-- Template para cuando no hay datos -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" style="text-align: center; padding: 20px; background-color: #fff;">
            <div class="no-data-message">
              <i class="pi pi-info-circle" style="font-size: 2.5rem; color: #888;"></i>
              <p style="margin-top: 10px; font-size: 1.2rem; color: #888;">No tiene pagos realizados para esta planilla de aportes</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  

  

  </div>
    <!-- Modal para crear pago -->


    <p-dialog 
    #createPagoDialog 
    [(visible)]="displayDialog" 
    [modal]="true" 
    [closable]="true"
    (onHide)="onDialogHide()"
    [style]="{ width: '1100px' }"
  >
    <form [formGroup]="pagoForm" (ngSubmit)="onSubmit()" class="p-fluid">
      <!-- Stepper -->
      <p-steps [model]="steps" [(activeIndex)]="activeStep" [readonly]="false"></p-steps>
  
      <!-- Paso 1: Seleccionar Fecha de Pago -->
      <div *ngIf="activeStep === 0" class="step-content">
        <div class="caja-contenido">
          <h3>Selecciona la Fecha de Pago</h3>
          <div class="p-field">
            <input 
              pInputText 
              type="datetime-local" 
              id="fecha_pago" 
              formControlName="fecha_pago" 
              required
            >
            <small *ngIf="pagoForm.get('fecha_pago')?.invalid && pagoForm.get('fecha_pago')?.touched" class="p-error">
              La fecha de pago es obligatoria.
            </small>
          </div>
          <div class="contenedor-centrar">
            <div class="p-field">
              <button 
              pButton 
              type="button" 
              label="Cancelar" 
              (click)="displayDialog = false" 
              class="p-button-secondary"
            ></button>
              <button 
                pButton 
                type="button" 
                label="Calcular Pago" 
                (click)="calcularTotalACancelar()" 
                [disabled]="pagoForm.get('fecha_pago')?.invalid || calculating"
                [loading]="calculating"
                class="p-button-primary"
              ></button>
  
            </div>
          </div>
          
        </div>
      </div>
        
  
      <!-- Paso 2: Revisar Detalles del Cálculo -->
       <div *ngIf="activeStep === 1 && calculoDetalles" class="step-content" role="region" aria-labelledby="summary-title">

  <div class="summary-section">
    <!-- Grupo A: Aportes -->
    <section class="group-section aportes" aria-labelledby="aportes-header">
      <div class="group-header" id="aportes-header">Liquidación de Aportes</div>
      <table class="summary-table">
        <tbody>
          <tr>
            <td class="amount-label">Tipo de Empresa</td>
            <td class="amount-value values" colspan="3">
              <ng-container [ngSwitch]="calculoDetalles.tipo_empresa">
                <span *ngSwitchCase="'AP'">Pública</span>
                <span *ngSwitchCase="'AV'">Privada</span>
                <span *ngSwitchCase="'PA'">Pasiva</span>
                <span *ngSwitchCase="'VA'">Decreto Supremo</span>
                <span *ngSwitchDefault>{{ calculoDetalles.tipo_empresa }}</span>
              </ng-container>
            </td>
          </tr>
          <tr>
            <td class="amount-label">Tasa</td>
            <td class="amount-value values" colspan="3">
              <ng-container [ngSwitch]="calculoDetalles.cotizacion_tasa">
                <span *ngSwitchCase="0.1">10 %</span>
                <span *ngSwitchCase="0.03">3 %</span>
                <span *ngSwitchDefault>{{ calculoDetalles.cotizacion_tasa | number:'1.2-2' }} %</span>
              </ng-container>
            
            </td>
          </tr>
          <tr>
            <td class="amount-label">Fecha Presentación Oficial</td>
            <td class="amount-value values">
              {{ calculoDetalles.fechaFormal | date:'dd/MM/yyyy':'+0000' }}
            </td>
            <td class="amount-label" style="text-align: right;">UFV FD</td>
            <td class="amount-value values ufv-cell">
              {{ calculoDetalles.ufv_dia_formal | number:'1.5-5' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Fecha de Depósito o Presentación</td>
            <td class="amount-value values">
              {{ calculoDetalles.fechaPagoUfv | date:'dd/MM/yyyy':'+0000' }}
            </td>
            <td class="amount-label" style="text-align: right;">UFV FP</td>
            <td class="amount-value values ufv-cell">
              {{ calculoDetalles.ufv_dia_presentacion | number:'1.5-5' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Cálculo con Vigencia Hasta el Día</td>
            <td class="amount-value values">
              {{ calculoDetalles.fecha_pago | date:'dd/MM/yyyy':'+0000' }}
            </td>
            <td class="amount-label" style="text-align: right;">Salario Cotizable</td>
            <td class="amount-value values" [ngStyle]="{'color': calculoDetalles.total_importe === 0 ? '#dc2626' : 'inherit'}">
              {{ calculoDetalles.total_importe | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr class="subtotal">
            <td class="amount-label">Subtotal Aportes</td>
            <td class="amount-value values" colspan="3">
              {{ calculoDetalles.aporte_porcentaje | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Grupo B: Recargos -->
    <section class="group-section recargos" aria-labelledby="recargos-header">
      <div class="group-header" id="recargos-header">Recargos de Ley</div>
      <table class="summary-table">
        <tbody>
          <tr>
            <td class="amount-label">Días en Mora</td>
            <td class="amount-value values-r" colspan="3" style="color: rgb(141, 52, 52);">
              {{ calculoDetalles.dias_retraso }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">AP - AC (si corresponde)</td>
            <td class="amount-value values-r" colspan="3">
              {{ calculoDetalles.monto_actualizado | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Interés</td>
            <td class="amount-value values-r" colspan="3">
              {{ calculoDetalles.intereses | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Multas s/Interés (10%)</td>
            <td class="amount-value values-r" colspan="3">
              {{ calculoDetalles.multa_sobre_intereses | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Multa No Presentación (1%)</td>
            <td class="amount-value values-r" colspan="3">
              {{ calculoDetalles.multa_no_presentacion | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr class="subtotal">
            <td class="amount-label">Subtotal Recargos de Ley</td>
            <td class="amount-value values-r" colspan="3">
              {{ calculoDetalles.total_multas | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Grupo C: Deducciones -->
    <section class="group-section deducciones" aria-labelledby="deducciones-header">
      <div class="group-header" id="deducciones-header">Deducciones</div>
      <table class="summary-table">
        <tbody>
          <tr>
            <td class="amount-label">Descuento de 5% para el Ministerio de Salud Ley 2042</td>
            <td class="amount-value values-b" colspan="3">
              {{ calculoDetalles.descuento_min_salud | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr>
            <td class="amount-label">Otros Descuentos</td>
            <td class="amount-value values-b" colspan="3">
              {{ calculoDetalles.otros_descuentos | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
          <tr class="subtotal">
            <td class="amount-label">Subtotal Deducciones</td>
            <td class="amount-value values-b" colspan="3">
              {{ (calculoDetalles.descuento_min_salud + calculoDetalles.otros_descuentos) | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Total Final -->
    <section class="group-section total" aria-labelledby="total-header">
      <div class="group-header" id="total-header">Total</div>
      <table class="summary-table">
        <tbody>
          <tr class="total-row">
            <td class="amount-label">Total a Cancelar</td>
            <td class="amount-value" colspan="3" [ngStyle]="{'color': calculoDetalles.total_a_cancelar === 0 ? '#dc2626' : 'inherit'}">
              {{ calculoDetalles.total_a_cancelar | currency:'BOB':'symbol':'1.2-2' }}
            </td>
          </tr>
        </tbody>
      </table>
    </section>
  </div>

  <div class="contenedor-centrar">
    <button pButton type="button" label="Atrás" (click)="activeStep = 0" class="p-button-secondary" aria-label="Volver al paso anterior"></button>
    <button pButton type="button" label="Siguiente" (click)="activeStep = 2" class="p-button-primary" aria-label="Avanzar al siguiente paso"></button>
  </div>
</div>
  
      <!-- Paso 3: Ingresar Detalles del Pago -->
      <div *ngIf="activeStep === 2 && calculoDetalles" class="p-fluid" style="max-width: 800px; margin: 0 auto;">
        <h3 style="color: #2c3e50; margin-bottom: 1.5rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Detalles del Pago</h3>
        
        <div class="p-grid p-fluid" style="gap: 2rem; margin-bottom: 1.5rem;">
          <!-- Columna Izquierda -->
          <div class="p-col-12 p-md-6" style="display: flex; gap: 1rem;flex-wrap: wrap;">
            <div class="p-form">
              <label for="monto_pagado" style="font-weight: 500; color: #555; font-size: 0.9rem;">Monto Pagado (BOB)</label>
              <input pInputText type="number" id="monto_pagado" formControlName="monto_pagado" step="0.01" required [readonly]="true"
                     style="width: 100%; padding: 0.5rem;" >
              <small *ngIf="pagoForm.get('monto_pagado')?.hasError('montoInsuficiente') && pagoForm.get('monto_pagado')?.touched" 
                     class="p-error" style="color: #f44336;">
                El monto pagado no puede ser menor que el total a cancelar | ({{ calculoDetalles.total_a_cancelar | currency:'BOB':'symbol':'1.2-2' }}).
              </small>
              <small *ngIf="pagoForm.get('monto_pagado')?.hasError('required') && pagoForm.get('monto_pagado')?.touched" 
                     class="p-error" style="color: #f44336;">
                El monto pagado es obligatorio.
              </small>
            </div>
      
            <div class="p-form">
              <label for="comprobante_pago" style="font-weight: 500; color: #555; font-size: 0.9rem;">Número de Comprobante</label>
              <input pInputText id="comprobante_pago" formControlName="comprobante_pago" style="width: 100%; padding: 0.5rem;">
            </div>
      
            <div class="p-form">
              <label for="foto_comprobante" style="font-weight: 500; color: #555; font-size: 0.9rem;">Subir Comprobante</label>
              <input pInputText type="file" id="foto_comprobante" (change)="onFileSelected($event)" accept="image/jpeg,image/png,application/pdf">
              <small style="color: #666; font-size: 0.8rem; margin-top: 0.25rem;">Formatos aceptados: JPG, PNG, PDF (Máx. 1MB)</small>
              <small *ngIf="!selectedFile && pagoForm.touched" class="p-error" style="color: #f44336;">Debes subir un comprobante.</small>
            </div>
          </div>
      
          <!-- Columna Derecha -->
          <div class="p-col-12 p-md-6" style="display: flex; flex-direction: column; gap: 1rem; ">
            <div class="p-form">
              <label for="metodo_pago" style="font-weight: 500; color: #555; font-size: 0.9rem;">Método de Pago</label>
              <p-dropdown id="metodo_pago" [options]="metodoPagoOptions" formControlName="metodo_pago" 
                         placeholder="Seleccione método" [style]="{'width': '100%', 'padding': '0.5rem'}"></p-dropdown>
            </div>
      
            <div class="p-form">
              <label for="observaciones" style="font-weight: 500; color: #555; font-size: 0.9rem;">Observaciones</label>
              <textarea pInputTextarea id="observaciones" formControlName="observaciones" rows="3"
                       style="width: 100%; min-height: 100px; resize: vertical; padding: 0.5rem;"></textarea>
            </div>
          </div>
        </div>
      
        <!-- Botones -->
        <div class="contenedor-centrar">
          <div class="p-field">
            <button pButton type="button" label="Atrás" (click)="activeStep = 1" class="p-button-secondary"></button>
            <button pButton type="button" label="Siguiente" (click)="activeStep = 3" class="p-button-primary"></button>
          </div>
        </div>
      </div>
  
      <!-- Paso 4: Confirmación -->
      <div *ngIf="activeStep === 3 && calculoDetalles" class="p-fluid">
        <h3>Confirmación</h3>
        <p>Revisa los detalles antes de crear el pago:</p>
        <div class="grid">
          <!-- Resumen del Pago (Izquierda) -->
          <div class="col-6" >
            <p-panel header="Resumen del Pago" >
              <div class="p-fluid">
                <div class="p-field">
                  <label><strong>Fecha de Pago:</strong></label>
                  <p>{{ pagoForm.get('fecha_pago')?.value | date:'dd/MM/yyyy HH:mm' }}</p>
                </div>
                <div class="p-field">
                  <label><strong>Monto Pagado:</strong></label>
                  <p>{{ pagoForm.get('monto_pagado')?.value | currency:'BOB':'symbol':'1.2-2' }}</p>
                </div>
                <div class="p-field">
                  <label><strong>Método de Pago:</strong></label>
                  <p>{{ pagoForm.get('metodo_pago')?.value || 'No especificado' }}</p>
                </div>
                <div class="p-field">
                  <label><strong>Comprobante:</strong></label>
                  <p>{{ pagoForm.get('comprobante_pago')?.value || 'No especificado' }}</p>
                </div>
                <div class="p-field">
                  <label><strong>Observaciones:</strong></label>
                  <p>{{ pagoForm.get('observaciones')?.value || 'Ninguna' }}</p>
                </div>
                <div class="p-field">
                  <label><strong>Archivo Name:</strong></label>
                  <p>{{ selectedFile?.name }}</p>
                </div>
              </div>
            </p-panel>
          </div>
      
          <!-- Vista Previa del Comprobante (Derecha) -->
          <div class="col-6" *ngIf="selectedFile" >
            <p-panel header="Vista Previa del Comprobante">
              <div class="p-text-center">
                <ng-container *ngIf="previewUrl">
                  <img *ngIf="!isPdf" [src]="previewUrl" alt="Vista previa del comprobante" class="preview-image">
                  <iframe *ngIf="isPdf" [src]="previewUrl" class="preview-pdf" (error)="onIframeError($event)"></iframe>
                </ng-container>
                <p *ngIf="!previewUrl">Cargando vista previa...</p>
                
              </div>
            </p-panel>
          </div>
        </div>
      
        <div class="p-field p-mt-3">
          <button pButton type="button" label="Atrás" (click)="activeStep = 2" class="p-button-secondary p-mr-2"></button>
          <button pButton type="submit" label="Registrar Pago" class="p-button-primary" [disabled]="pagoForm.invalid || !selectedFile"></button>
        </div>
      </div>
    </form>
  <!--   <p-messages></p-messages> -->
  </p-dialog>
  




<!-- Modal para mostrar la imagen o PDF -->
<p-dialog 
  #imageDialog 
  
  [(visible)]="displayImageDialog" 
  [modal]="true" 
  [style]="{ width: '850px' }" 
  [closable]="true"
  (onHide)="selectedImageUrl = ''"
>
  <div class="image-container">
    <!-- Verificación alternativa para PDFs -->
    <iframe 
      *ngIf="selectedImageUrl && selectedImageUrl.endsWith('.pdf')" 
      [src]="selectedImageUrl | safeUrl" 
      style="width: 800px; height: 600px; border: none;" 
      type="application/pdf" 
      frameborder="0"
      (error)="onIframeError($event)"
    ></iframe>
    <div *ngIf="selectedImageUrl && selectedImageUrl.endsWith('.pdf') && !isPdfLoaded" class="pdf-error">
      <p>No se pudo cargar el PDF. <a [href]="selectedImageUrl" target="_blank">Haga clic aquí para descargarlo</a>.</p>
    </div>
    <img 
      *ngIf="selectedImageUrl && !selectedImageUrl.endsWith('.pdf')" 
      [src]="selectedImageUrl" 
      style="width: 800px; height: auto; max-height: 600px; object-fit: contain;" 
      alt="Comprobante"
    >
  </div>

</p-dialog>


  </div>