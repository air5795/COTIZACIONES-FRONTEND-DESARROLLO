

<div class="buscar-trabajador-container">
  <div class="info-section">
    <h5 class="section-title"><i class="pi pi-search"></i> Buscar Trabajador por Matrícula</h5>
    <div class="p-4">
      <!-- Formulario de búsqueda -->
      <form [formGroup]="buscarForm" (ngSubmit)="buscarBajasMedicas()">
        <div class="p-field">
          <label for="matricula">Ingrese la Matrícula del Trabajador</label>
          <div class="p-inputgroup">
            <input 
              id="matricula"
              type="text" 
              pInputText 
              formControlName="matricula"
              placeholder="Ej: 61-5204 AAA"
              class="p-inputtext-lg"
              [class.p-invalid]="buscarForm.get('matricula')?.invalid && buscarForm.get('matricula')?.touched">
            <button 
              type="submit" 
              pButton 
              pRipple 
              label="" 
              icon="pi pi-search"
              class="p-button-primary p-button-lg"
              [loading]="cargandoBusqueda"
              [disabled]="buscarForm.invalid">
            </button>
          </div>
          <small class="p-error" *ngIf="buscarForm.get('matricula')?.invalid && buscarForm.get('matricula')?.touched">
            Formato requerido: XX-XXXX XXX
          </small>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Resultados de la Búsqueda -->
<div class="resultados-container" *ngIf="mostrarDialogBajas && !cargandoBusqueda">
    <div class="resultados-header-section">
      <div class="header-content">
        <i class="pi pi-list header-icon"></i>
        <h4 class="resultados-title">Bajas Médicas Encontradas</h4>
        <span class="resultados-count">({{ bajasEncontradas.length }})</span>
      </div>
      <button 
        pButton 
        pRipple 
        type="button" 
        icon="pi pi-times" 
        class="p-button-rounded p-button-sm p-button-outlined" 
        pTooltip="Limpiar resultados"
        tooltipPosition="left"
        (click)="limpiarResultados()">
      </button>
    </div>
  
    <!-- Tabla de Bajas Médicas -->
    <div class="bajas-table-container">
      <p-table 
        [value]="bajasEncontradas" 
        [paginator]="bajasEncontradas.length > 5" 
        [rows]="5"
        [rowsPerPageOptions]="[5, 10, 20]"
        styleClass="p-datatable-sm p-datatable-striped"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} bajas"
        [globalFilterFields]="['TIPO_BAJA', 'MEDI_NOM', 'ESP_NOM', 'ASE_MAT']">
        
        <ng-template pTemplate="header">
          <tr>
            <th>Tipo</th>
            <th>Matrícula</th>
            <th>Médico</th>
            <th>Especialidad</th>
            <th>Período</th>
            <th>Días</th>
            <th>Acción</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-baja>
          <tr class="baja-row" [ngClass]="getTipoIncapacidadClass(baja.TIPO_BAJA)">
            <td>
              <span class="tipo-badge" [ngClass]="getTipoIncapacidadClass(baja.TIPO_BAJA)">
                {{ baja.TIPO_BAJA.trim() }}
              </span>
            </td>
            <td>
              <div class="matricula-cell">
                <i class="pi pi-user"></i>
                <span>{{ baja.ASE_MAT }}</span>
              </div>
            </td>
            <td class="medico-cell">{{ baja.MEDI_NOM }}</td>
            <td class="especialidad-cell">{{ baja.ESP_NOM }}</td>
            <td>
              <div class="periodo-cell">
                <small>{{ formatDate(baja.DIA_DESDE) }}</small>
                <i class="pi pi-arrow-right periodo-arrow"></i>
                <small>{{ formatDate(baja.DIA_HASTA) }}</small>
              </div>
            </td>
            <td>
              <div class="dias-cell">
                <span class="dias-numero">{{ baja.DIAS_IMPEDIMENTO }}</span>
                <small>días</small>
              </div>
            </td>
            <td>
              <button 
                pButton 
                pRipple 
                type="button" 
                icon="pi pi-calculator" 
                label="Seleccionar"
                class="p-button-sm p-button-success" 
                pTooltip="Calcular reembolso"
                (click)="seleccionarBaja(baja)">
              </button>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center p-3">
              <i class="pi pi-search" style="font-size: 2rem; color: #ccc;"></i>
              <p class="mt-2 mb-0">No se encontraron bajas médicas</p>
            </td>
          </tr>
        </ng-template>
        
      </p-table>
    </div>
  </div>
  
  <!-- Dialog para calcular reembolso -->
  <p-dialog 
    header="Calcular Reembolso" 
    [(visible)]="mostrarDialogCalculo" 
    [modal]="true" 
    [style]="{width: '90vw', maxWidth: '1200px'}" 
    [contentStyle]="{'padding': '1rem'}"
    (onHide)="cerrarDialogCalculo()" 
    appendTo="body">
    <div class="calculo-container-dialog" *ngIf="bajaSeleccionada">
  
      <!-- Columna 1: Información de la Baja -->
      <div class="info-section">
        <h5 class="section-title"><i class="pi pi-info-circle"></i> Información de la Baja</h5>
        <div class="contable-style">
          <div class="detalle-linea">
            <span>Tipo:</span>
            <span>
              <span class="tipo-badge" [ngClass]="getTipoIncapacidadClass(bajaSeleccionada.TIPO_BAJA)">
                {{ bajaSeleccionada.TIPO_BAJA.trim() }}
              </span>
            </span>
          </div>
          <div class="detalle-linea">
            <span>Matrícula:</span>
            <span>{{ bajaSeleccionada.ASE_MAT }}</span>
          </div>
          <div class="detalle-linea">
            <span>Especialidad:</span>
            <span>{{ bajaSeleccionada.ESP_NOM }}</span>
          </div>
          <div class="detalle-linea">
            <span>Médico:</span>
            <span>{{ bajaSeleccionada.MEDI_NOM }}</span>
          </div>
          
          <p-divider styleClass="my-2"></p-divider>
          
          <div class="detalle-linea">
            <span>Desde:</span>
            <span>{{ formatDate(bajaSeleccionada.DIA_DESDE) }}</span>
          </div>
          <div class="detalle-linea">
            <span>Hasta:</span>
            <span>{{ formatDate(bajaSeleccionada.DIA_HASTA) }}</span>
          </div>
          <div class="detalle-linea">
            <span>Días totales:</span>
            <span class="dias-totales-val">{{ bajaSeleccionada.DIAS_IMPEDIMENTO }}</span>
          </div>
          
          <p-divider styleClass="my-2"></p-divider>
          
          <div class="detalle-linea">
            <span>Comprobante:</span>
            <span>{{ bajaSeleccionada.COMPROBANTE }}</span>
          </div>
        </div>
      </div>
  
      <!-- Columna 2: Datos del Trabajador -->
      <div class="info-section">
        <h5 class="section-title"><i class="pi pi-user"></i> Datos del Trabajador</h5>
        <div class="form-grid dialog-form-grid">
          <div class="p-field">
            <label for="ci">Cédula de Identidad</label>
            <input id="ci" type="text" pInputText [(ngModel)]="datosWorker.ci" readonly>
          </div>
          <div class="p-field">
            <label for="nombres">Nombres</label>
            <input id="nombres" type="text" pInputText [(ngModel)]="datosWorker.nombres">
          </div>
          <div class="p-field">
            <label for="apellido_paterno">Apellido Paterno</label>
            <input id="apellido_paterno" type="text" pInputText [(ngModel)]="datosWorker.apellido_paterno">
          </div>
          <div class="p-field">
            <label for="apellido_materno">Apellido Materno</label>
            <input id="apellido_materno" type="text" pInputText [(ngModel)]="datosWorker.apellido_materno">
          </div>
          <div class="p-field grid-col-span-2">
            <label for="salario">Salario Total Ganado (BS.)</label>
            <p-inputNumber id="salario" [(ngModel)]="datosWorker.salario" mode="currency" currency="BOB" locale="es-BO"></p-inputNumber>
          </div>
        </div>
        <div class="p-text-center p-mt-3">
          <button pButton pRipple label="Calcular" icon="pi pi-calculator" class="p-button-primary" (click)="calcularYMostrarReembolso()"></button>
        </div>
      </div>
  
      <!-- Columna 3: Resultado del Cálculo -->
      <div class="info-section result-section">
        <h5 class="section-title"><i class="pi pi-money-bill"></i> Resultado del Cálculo</h5>
        
        <!-- Contenido Real del Cálculo -->
        <ng-container *ngIf="detalleCalculado; else placeholderCalculo">
          <div class="calculo-resultado-dialog">
            <div class="calculo-detalle contable-style">
              <div class="detalle-linea">
                <span>Días de incapacidad:</span>
                <span>{{ detalleCalculado.dias_incapacidad }}</span>
              </div>
              <div class="detalle-linea">
                <span>Días para reembolso:</span>
                <span class="dias-reembolso-val">{{ detalleCalculado.dias_reembolso }}</span>
              </div>
              <small *ngIf="detalleCalculado.tipo_incapacidad === 'ENFERMEDAD'" class="detalle-nota">(Se descuentan 3 días por enfermedad)</small>
              
              <p-divider styleClass="my-2"></p-divider>
              
              <div class="detalle-linea">
                <span>Salario base por día:</span>
                <span>{{ detalleCalculado.monto_dia | currency:'BOB':'symbol':'1.2-2' }}</span>
              </div>
              <div class="detalle-linea">
                <span>Porcentaje de reembolso:</span>
                <span>{{ detalleCalculado.porcentaje_reembolso }}%</span>
              </div>
            </div>
            
            <div class="monto-final-contable">
              <span class="monto-label">Monto Total a Reembolsar</span>
              <span class="monto-valor">{{ detalleCalculado.monto_reembolso | currency:'BOB':'symbol':'1.2-2' }}</span>
            </div>
          </div>
          
          <div class="p-mt-auto">
            <button pButton pRipple label="Confirmar y Agregar" icon="pi pi-check" class="p-button-success p-button-lg w-full" (click)="confirmarYAgregar()"></button>
          </div>
        </ng-container>
  
        <!-- Placeholder mientras no hay cálculo -->
        <ng-template #placeholderCalculo>
          <div class="placeholder-container">
            <i class="pi pi-chart-line placeholder-icon"></i>
            <p class="placeholder-text">Los resultados del cálculo aparecerán aquí.</p>
            <div class="p-mt-4">
              <p-skeleton width="80%" height="1.5rem" styleClass="p-mb-2"></p-skeleton>
              <p-skeleton width="60%" height="1.5rem"></p-skeleton>
            </div>
          </div>
        </ng-template>
  
      </div>
  
    </div>
  </p-dialog>